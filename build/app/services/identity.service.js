"use strict";var __decorate=this&&this.__decorate||function(e,t,o,n){var r,i=arguments.length,a=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,n);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(a=(i<3?r(a):i>3?r(t,o,a):r(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},core_1=require("@angular/core"),config_data_1=require("../data/config.data"),IdentityService=function(){function e(){this._authProvider=config_data_1.CONFIG.authProvider,this._expireOffsetMilliseconds=18e5,this._renewInProgress=!1,this._state=null}return e.prototype.clearToken=function(){clearInterval(this.refreshTimer),localStorage.removeItem("id_token"),this.id_token=null,localStorage.removeItem("state"),this._state=null},e.prototype.appendAuthHeader=function(e){return this.id_token&&e.append("Authorization","Bearer "+this.id_token),e},e.prototype.getToken=function(){localStorage.setItem("redirectUrl",location.href);var e=null;this._state=this.getUuid(),localStorage.setItem("state",this._state),"AzureAD"==this._authProvider.name?e=this._authProvider.authUrl+"?response_type=id_token&client_id="+this._authProvider.clientId+"&redirect_uri="+encodeURIComponent(this._authProvider.redirectUrl)+"&state="+this._state+"&nonce="+this._state:"Google"==this._authProvider.name&&(e=this._authProvider.authUrl+"?scope="+encodeURIComponent("openid email")+"&response_type=id_token&client_id="+this._authProvider.clientId+"&redirect_uri="+encodeURIComponent(this._authProvider.redirectUrl)+"&state="+this._state),null!=e&&window.location.replace(e)},e.prototype.isTokenValid=function(){var e=!1;if(null==this.id_token&&(this.id_token=localStorage.getItem("id_token"),null!=this.id_token&&(this.token=this.extractToken(this.id_token),null==this.refreshTimer&&(this.refreshTimer=setInterval(this.renewToken,this._expireOffsetMilliseconds)))),null!=this.id_token){var t=new Date(1e3*this.token.exp),o=new Date;t<o?this.clearToken():e=!0}return e},e.prototype.renewToken=function(){var e=this;if(console.log("identitySvc.renewToken()"),!this._renewInProgress&&this.isTokenValid()){this._renewInProgress=!0,this._state=this.getUuid(),localStorage.setItem("state",this._state);var t=null;if("AzureAD"==this._authProvider.name?(t=this._authProvider.authUrl+"?response_type=id_token&client_id="+this._authProvider.clientId+"&redirect_uri="+encodeURIComponent(this._authProvider.redirectUrl)+"&state="+this._state+"&nonce="+this._state,t+="&prompt=none&login_hint="+encodeURIComponent(this.getLoginHint())+"&domain_hint="+encodeURIComponent(this.getDomainHint())):"Google"==this._authProvider.name&&(t=this._authProvider.authUrl+"?scope=email&response_type=id_token&client_id="+this._authProvider.clientId+"&redirect_uri="+encodeURIComponent(this._authProvider.redirectUrl)+"&state="+this._state+"&nonce="+this._state,t+="&prompt=none&login_hint="+encodeURIComponent(this.getLoginHint())),null!=t){localStorage.removeItem("redirectUrl");var o=this.addIFrame("tokenRenewFrame");o.src="about:blank",this.loadFrame(t,"tokenRenewFrame"),setTimeout(function(){e._renewInProgress=!1,e.id_token=localStorage.getItem("id_token"),null!=e.id_token?(e.token=e.extractToken(e.id_token),console.log("Token renewed successfully.  New expiration = "+new Date(1e3*e.token.exp))):(console.log("Token renewal failed.  Expiration = "+new Date(1e3*e.token.exp)),setTimeout(e.renewToken,3e5))},6e4)}}},e.prototype.base64DecodeStringUrlSafe=function(e){return window.atob?window.atob(e):(console.log("Browser is not supported"),null)},e.prototype.decodeJwt=function(e){var t=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/,o=t.exec(e);if(!o||o.length<4)return console.log("The returned token is not parseable."),null;var n={header:o[1],payload:o[2],signature:o[3]};return n},e.prototype.base64Decode=function(e){try{var t=this.base64DecodeStringUrlSafe(e);return t?JSON.parse(t):(console.log("identity.base64Decode -> Could not be base64 url safe decoded."),null)}catch(e){console.log("identity.base64Decode -> Could not be decoded: "+e.stack)}return null},e.prototype.extractHeader=function(e){var t=this.decodeJwt(e);return t?this.base64Decode(t.header):null},e.prototype.extractSignature=function(e){var t=this.decodeJwt(e);return t?this.base64Decode(t.signature):null},e.prototype.extractToken=function(e){var t=this.decodeJwt(e),o=null;o=t?t.payload:e;try{var n=this.base64DecodeStringUrlSafe(o);return n?JSON.parse(n):(console.log("The returned token could not be base64 url safe decoded."),null)}catch(e){console.log("The returned token could not be decoded: "+e.stack)}return null},e.prototype.getDomainHint=function(){if(this.token&&this.token.upn&&this.token.upn.indexOf("@")>-1){var e=this.token.upn.split("@");return e[e.length-1]}return""},e.prototype.getLoginHint=function(){var e="";return"AzureAD"==this._authProvider.name?this.token&&this.token.upn&&(e=this.token.upn):"Google"==this._authProvider.name&&this.token&&this.token.email&&(e=this.token.email),e},e.prototype.getUuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,o="x"==e?t:3&t|8;return o.toString(16)})},e.prototype.addIFrame=function(e){var t=document.getElementById(e);if(!t){if(document.createElement&&document.documentElement&&window.navigator.userAgent.indexOf("MSIE 5.0")===-1){var o=document.createElement("iframe");o.setAttribute("id",e),o.style.visibility="hidden",o.style.position="absolute",o.style.width=o.style.height=o.border="0px",t=document.getElementsByTagName("body")[0].appendChild(o)}else document.body&&document.body.insertAdjacentHTML&&document.body.insertAdjacentHTML("beforeEnd",'<iframe name="'+e+'" id="'+e+'" style="display:none"></iframe>');window.frames&&window.frames[e]&&(t=window.frames[e])}return t},e.prototype.removeIFrame=function(e){var t=document.getElementById(e);t.parentNode.removeChild(t)},e.prototype.loadFrame=function(e,t){var o=this;setTimeout(function(){var n=o.addIFrame(t);""!==n.src&&"about:blank"!==n.src||(n.src=e,o.loadFrame(e,t))},500)},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[])],e)}();exports.IdentityService=IdentityService;