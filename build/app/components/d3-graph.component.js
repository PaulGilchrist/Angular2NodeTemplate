"use strict";var __decorate=this&&this.__decorate||function(t,e,a,n){var r,o=arguments.length,i=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,a):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,a,n);else for(var s=t.length-1;s>=0;s--)(r=t[s])&&(i=(o<3?r(i):o>3?r(e,a,i):r(e,a))||i);return o>3&&i&&Object.defineProperty(e,a,i),i},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},core_1=require("@angular/core"),D3GraphComponent=function(){function t(t){this.el=t,this.isReady=!1,this.data=null,this.height=300,this.labels="all",this.warningLevel=1/0,this.width=350,this.type="bar",this.xKey="x",this.yKey="y",this.xType="number"}return t.prototype.ngOnInit=function(){this.isReady=!0,this._tooltip=d3.select("body").append("div").attr("class","d3-tooltip").style({opacity:0,"pointer-events":"none",position:"absolute"}),this.draw()},t.prototype.ngOnChanges=function(){this.isReady&&this.draw()},t.prototype.createBarGraph=function(){var t=this,e=2,a=t.height/d3.max(t.data,function(e){return e[t.yKey]}),n=t.width/t.data.length,r=d3.select(t.el.nativeElement).append("svg").attr({width:t.width,height:t.height});r.selectAll("rect").data(t.data).enter().append("rect").attr({x:function(t,e){return e*n},y:function(e){return t.height-e[t.yKey]*a},width:n-e,height:function(e){return e[t.yKey]*a},class:function(e){return t.classPicker(e[t.yKey],t.warningLevel)}}).on("mouseover",function(e){t._tooltip.transition().duration(500).style("opacity",.9);var a="<strong>"+t.xKey+":</strong> "+e[t.xKey]+"<br/>";a+="<strong>"+t.yKey+":</strong> "+e[t.yKey]+"<br/>",t._tooltip.html(a).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px"),r.append("text").text(e[t.yKey]).attr({x:parseFloat(d3.select(this).attr("x"))+parseFloat(d3.select(this).attr("width"))/2,y:parseFloat(d3.select(this).attr("y"))+14,"text-anchor":"middle",id:"hoverLabel_"+e[t.yKey]})}).on("mouseout",function(e){t._tooltip.transition().duration(500).style("opacity",0),d3.select("#hoverLabel_"+e[t.yKey]).remove()}),r.selectAll("text").data(t.data).enter().append("text").text(function(e){return t.showLabels(t.yKey,e[t.yKey],t.labels,!0)}).attr({x:function(t,a){return a*n+(n-e)/2},y:function(e){return t.height-e[t.yKey]*a+14},"text-anchor":"middle"})},t.prototype.createLineChart=function(){var t=this,e=26,a="date"==this.xType,n=this.scale(t.xKey,[e+5,t.width-10],!0),r=this.scale(t.yKey,[t.height-e,10],!1),o=d3.svg.axis().scale(n).orient("bottom");a&&o.tickFormat(d3.time.format("%b"));var i=d3.svg.axis().scale(r).orient("left"),s=d3.svg.line().x(function(e){return n(a?new Date(e[t.xKey]):e[t.xKey])}).y(function(e){return r(e[t.yKey])}).interpolate("linear"),c=d3.select(t.el.nativeElement).append("svg").attr({width:t.width,height:t.height});c.append("path").attr("class","d3-path").attr({d:s(t.data),fill:"none"}),c.selectAll("circle").data(t.data).enter().append("circle").attr({cx:function(e){return n(a?new Date(e[t.xKey]):e[t.xKey])},cy:function(e){return r(e[t.yKey])},r:3,class:function(e){return t.classPicker(e[t.yKey],t.warningLevel)}}).on("mouseover",function(e){t._tooltip.transition().duration(500).style("opacity",.9);var a="<strong>"+t.xKey+":</strong> "+e[t.xKey]+"<br/>";a+="<strong>"+t.yKey+":</strong> "+e[t.yKey]+"<br/>",t._tooltip.html(a).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(e){t._tooltip.transition().duration(500).style("opacity",0)}),c.selectAll("text").data(t.data).enter().append("text").text(function(e){return t.showLabels(t.yKey,e[t.yKey],t.labels,!0)}).attr({x:function(e){return n(a?new Date(e[t.xKey]):e[t.xKey])},y:function(e){return r(e[t.yKey])},"text-anchor":"start",class:function(e){return t.classPicker(e[t.yKey],t.warningLevel)}});c.append("g").call(o).attr({class:"d3-axis",transform:"translate(0, "+(t.height-e)+")"}),c.append("g").call(i).attr({class:"d3-axis",transform:"translate("+e+", 0)"})},t.prototype.createPieChart=function(){var t=this,e="date"==this.xType,a=d3.time.format("%b"),n=t.width/2,r=d3.scale.category20c(),o=d3.select(t.el.nativeElement).append("svg:svg").data([t.data]).attr({width:2*n,height:2*n}).append("svg:g").attr("transform","translate("+n+","+n+")"),i=d3.layout.pie().value(function(e){return e[t.yKey]}),s=d3.svg.arc().outerRadius(n),c=o.selectAll("g.slice").data(i).enter().append("svg:g").attr("class","slice");c.append("svg:path").attr({fill:function(t,e){return r(e)},d:function(t){return s(t)}}).on("mouseover",function(e,a){t._tooltip.transition().duration(500).style("opacity",.9);var n="<strong>"+t.xKey+":</strong> "+t.data[a][t.xKey]+"<br/>";n+="<strong>"+t.yKey+":</strong> "+t.data[a][t.yKey]+"<br/>",t._tooltip.html(n).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(e){t._tooltip.transition().duration(500).style("opacity",0)}),c.append("svg:text").attr({class:"d3-axis",transform:function(t){t.innerRadius=0,t.outerRadius=n;var e=.9*n,a=s.centroid(t),r=a[0],o=a[1],i=Math.sqrt(r*r+o*o);return"translate("+r/i*e+","+o/i*e+")"},"text-anchor":"middle"}).text(function(n,r){var o=d3.max(t.data,function(e){return e[t.yKey]}),i=d3.min(t.data,function(e){return e[t.yKey]}),s=t.data[r][t.xKey],c=t.data[r][t.yKey];if("none"!=t.labels&&("minmax"==t.labels&&(c==o||c==i)||"all"==t.labels))return e?a(new Date(s)):s})},t.prototype.createScatterPlot=function(){var t=this,e=26,a="date"==this.xType,n=this.scale(t.xKey,[e+5,t.width-10],!0),r=this.scale(t.yKey,[t.height-e,10],!1),o=d3.svg.axis().scale(n).orient("bottom");a&&o.tickFormat(d3.time.format("%b"));var i=d3.svg.axis().scale(r).orient("left"),s=d3.select(t.el.nativeElement).append("svg").attr({width:t.width,height:t.height});s.selectAll("circle").data(t.data).enter().append("circle").attr({cx:function(e){return n(a?new Date(e[t.xKey]):e[t.xKey])},cy:function(e){return r(e[t.yKey])},r:5,class:function(e){return t.classPicker(e[t.yKey],t.warningLevel)}}).on("mouseover",function(e){t._tooltip.transition().duration(500).style("opacity",.9);var a="<strong>"+t.xKey+":</strong> "+e[t.xKey]+"<br/>";a+="<strong>"+t.yKey+":</strong> "+e[t.yKey]+"<br/>",t._tooltip.html(a).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(e){t._tooltip.transition().duration(500).style("opacity",0)}),s.selectAll("text").data(t.data).enter().append("text").text(function(e){return t.showLabels(t.yKey,e[t.yKey],t.labels,!0)}).attr({x:function(e){return n(a?new Date(e[t.xKey]):e[t.xKey])},y:function(e){return r(e[t.yKey])},"text-anchor":"start",class:function(e){return t.classPicker(e[t.yKey],t.warningLevel)}});s.append("g").call(o).attr({class:"d3-axis",transform:"translate(0, "+(t.height-e)+")"}),s.append("g").call(i).attr({class:"d3-axis",transform:"translate("+e+", 0)"})},t.prototype.classPicker=function(t,e){return t>=e?"d3-warning":"d3-default"},t.prototype.draw=function(){switch(d3.select(this.el.nativeElement).selectAll("*").remove(),this.type){case"bar":this.createBarGraph();break;case"line":this.createLineChart();break;case"pie":this.createPieChart();break;case"scatter":this.createScatterPlot()}},t.prototype.scale=function(t,e,a){void 0===a&&(a=!1);var n,r,o,i=this;return"date"==this.xType?(n=new Date(d3.min(i.data,function(e){return e[t]})),r=new Date(d3.max(i.data,function(e){return e[t]})),o=d3.time.scale()):(n=a?d3.min(i.data,function(e){return e[t]}):0,r=d3.max(i.data,function(e){return e[t]}),o=d3.scale.linear()),o.domain([n,r]).range(e)},t.prototype.showLabels=function(t,e,a,n){void 0===n&&(n=!0);var r=this,o=d3.max(r.data,function(e){return e[t]}),i=0;if(n&&(i=d3.min(r.data,function(e){return e[t]})),"none"!=a&&("minmax"==a&&(e==o||e==i)||"all"==a))return e},__decorate([core_1.Input(),__metadata("design:type",Array)],t.prototype,"data",void 0),__decorate([core_1.Input(),__metadata("design:type",Number)],t.prototype,"height",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],t.prototype,"labels",void 0),__decorate([core_1.Input(),__metadata("design:type",Number)],t.prototype,"warningLevel",void 0),__decorate([core_1.Input(),__metadata("design:type",Number)],t.prototype,"width",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],t.prototype,"type",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],t.prototype,"xKey",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],t.prototype,"yKey",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],t.prototype,"xType",void 0),t=__decorate([core_1.Component({encapsulation:core_1.ViewEncapsulation.None,selector:"d3-graph",styleUrls:["app/components/d3-graph.component.css"],template:""}),__metadata("design:paramtypes",[core_1.ElementRef])],t)}();exports.D3GraphComponent=D3GraphComponent;